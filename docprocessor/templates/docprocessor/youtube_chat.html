{% extends 'docprocessor/base.html' %}

{% block content %}
<div class="container my-5">
  <h2 class="mb-4">YouTube Watch & Chat</h2>
  {% if not youtube_video %}
    <div class="card glass mb-4">
      <div class="card-header"><h5 class="mb-0">Paste YouTube URL</h5></div>
      <div class="card-body">
        <form method="post" action="{% url 'youtube_watch_chat' %}">
          {% csrf_token %}
          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label" for="ytUrl">URL</label>
              <input type="url" class="form-control" id="ytUrl" name="url" placeholder="https://www.youtube.com/watch?v=..." required>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-primary"><i class="fab fa-youtube me-2"></i>Load</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  {% else %}
    <div class="row">
      <div class="col-lg-8">
        <div class="card glass mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Video</h5>
            {% if youtube_video.title %}<span class="text-muted small">{{ youtube_video.title }}</span>{% endif %}
          </div>
          <div class="card-body">
            <div class="ratio ratio-16x9">
              {% if embed_url %}
              <iframe src="{{ embed_url }}" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
              {% else %}
              <div class="d-flex align-items-center justify-content-center bg-dark text-white" style="height:100%;">Unable to embed this video. <a class="ms-2" href="{{ youtube_video.url }}" target="_blank" rel="noopener">Open on YouTube</a></div>
              {% endif %}
            </div>
            <div class="mt-2 small"><a href="{{ youtube_video.url }}" target="_blank" rel="noopener">Open on YouTube</a></div>
          </div>
        </div>
        <!-- Standalone action buttons below the video (not inside a card) -->
        <div class="mt-3">
          <a href="{% url 'summarize' %}?youtube_id={{ youtube_video.id }}" class="btn btn-outline-secondary me-2 mb-2">
            <i class="fas fa-file-alt me-2"></i>Summarize
          </a>
          <a href="{% url 'generate' %}?youtube_id={{ youtube_video.id }}" class="btn btn-outline-secondary me-2 mb-2">
            <i class="fas fa-question-circle me-2"></i>Generate
          </a>
          <a href="{% url 'analyze' %}?youtube_id={{ youtube_video.id }}" class="btn btn-outline-secondary mb-2">
            <i class="fas fa-chart-line me-2"></i>Analyze
          </a>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card glass">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Chat Assistant</h5>
            <div class="d-flex align-items-center gap-2">
              {% if active_session %}
                <span class="badge bg-secondary">Session #{{ active_session.id }}</span>
              {% endif %}
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#contextCollapse" aria-expanded="false" aria-controls="contextCollapse">
                Show Context
              </button>
            </div>
          </div>
          <div class="collapse" id="contextCollapse">
            <div class="card-body pt-2">
              <div class="card glass">
                <div class="card-header"><h6 class="mb-0">Transcript Context</h6></div>
                <div class="card-body">
                  <div style="white-space: pre-wrap; font-family: inherit; max-height: 220px; overflow:auto;">{{ youtube_video.transcript }}</div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body chat-body">
            <!-- Thin progress bar while sending -->
            <div id="ytChatProgress" class="progress position-sticky" style="top:0; height:3px; display:none; z-index: 10;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" style="width:100%" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="Loading"></div>
            </div>
            <div class="chat-messages mb-3" id="chatMessages">
              {% for m in chat_messages %}
                <div class="d-flex mb-3">
                  {% if m.role == 'user' %}
                    <div class="message-bubble ms-auto p-3 rounded bubble-user">{{ m.content }}</div>
                  {% else %}
                    <div class="message-bubble me-auto p-3 rounded bubble-assistant">{{ m.content }}</div>
                  {% endif %}
                </div>
              {% empty %}
                <p class="text-muted">Ask a question about this video.</p>
              {% endfor %}
            </div>
            <form method="post" id="chatForm" action="{% url 'youtube_watch_chat' %}?video_id={{ youtube_video.id }}">
              {% csrf_token %}
              <input type="hidden" name="video_id" value="{{ youtube_video.id }}" />
              <input type="hidden" name="session_id" value="{{ active_session.id|default:'' }}" />
              <input type="hidden" name="system_prompt" id="hiddenSystemPrompt" />
              <input type="hidden" name="focus_mode" id="focusModeInput" value="0" />
              <div class="input-group align-items-stretch chat-input-group">
                <textarea class="form-control chat-input" name="message" rows="1" placeholder="Type your message..."></textarea>
                <button class="btn btn-primary btn-send" type="submit"><i class="fas fa-paper-plane me-2"></i>Send</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- KaTeX for LaTeX math rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous" onload="try{renderMathInElement(document.getElementById('chatMessages'),{delimiters:[{left:'$$',right:'$$',display:true},{left:'\\[',right:'\\]',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false}],throwOnError:false});}catch(e){}"></script>
<script>
// Minimal persona injection (reuse from chat page if needed later)
document.addEventListener('DOMContentLoaded', function(){
  const msgList = document.getElementById('chatMessages');
  const progressEl = document.getElementById('ytChatProgress');
  if (msgList) { msgList.scrollTop = msgList.scrollHeight; }
  const chatForm = document.getElementById('chatForm');
  if (chatForm) {
    // Helper: show a temporary Sending... bubble in the chat
    function showSendingBubble(list){
      const wrap = document.createElement('div');
      wrap.className = 'd-flex mb-3';
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble me-auto p-3 rounded bubble-assistant d-flex align-items-center gap-2';
      bubble.innerHTML = '<span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span><span class="text-muted">Sending...</span>';
      wrap.appendChild(bubble);
      list.appendChild(wrap);
      list.scrollTop = list.scrollHeight;
      return { remove(){ try { wrap.remove(); } catch(e){}; } };
    }

    // Helper: typewriter animation for assistant reply; then replace with formatted content
    function typeAssistantReply(list, text){
      const wrap = document.createElement('div');
      wrap.className = 'd-flex mb-3';
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble me-auto p-3 rounded bubble-assistant';
      const span = document.createElement('span');
      bubble.appendChild(span);
      wrap.appendChild(bubble);
      list.appendChild(wrap);
      list.scrollTop = list.scrollHeight;
      const full = String(text || '');
      const steps = Math.max(40, Math.min(120, Math.ceil(full.length / 8)));
      const chunk = Math.max(1, Math.ceil(full.length / steps));
      let idx = 0;
      const timer = setInterval(() => {
        const next = full.slice(idx, idx + chunk);
        span.textContent = (span.textContent || '') + next;
        idx += chunk;
        list.scrollTop = list.scrollHeight;
        if (idx >= full.length) {
          clearInterval(timer);
          // Replace with final formatted bubble
          bubble.innerHTML = '';
          const pre = document.createElement('div');
          pre.textContent = full; // plain first
          bubble.appendChild(pre);
          try { renderMathInElement(bubble, {delimiters:[{left:'$$',right:'$$',display:true},{left:'\\[',right:'\\]',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false}],throwOnError:false}); } catch(e) {}
        }
      }, 25);
    }

    // Progress controls
    function progressStart(){ try { if (progressEl) progressEl.style.display = 'block'; } catch(e){} }
    function progressStop(){ try { if (progressEl) progressEl.style.display = 'none'; } catch(e){} }

    chatForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const submitBtn = chatForm.querySelector('button[type="submit"]');
      // Grab user text and show it immediately in the chat
      const textarea = chatForm.querySelector('textarea[name="message"]');
      const userText = (textarea ? textarea.value : '').trim();
      if (!userText) return;
      const userWrap = document.createElement('div');
      userWrap.className = 'd-flex mb-3';
      const userBubble = document.createElement('div');
      userBubble.className = 'message-bubble ms-auto p-3 rounded bubble-user';
      userBubble.textContent = userText; // safe textContent
      userWrap.appendChild(userBubble);
      msgList.appendChild(userWrap);
      msgList.scrollTop = msgList.scrollHeight;
      if (textarea) textarea.value = '';
      let btnOriginal = '';
      if (submitBtn) { btnOriginal = submitBtn.innerHTML; submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending'; }
      const sending = showSendingBubble(msgList);
      progressStart();
      const formData = new FormData(chatForm);
      // Ensure cleared input does not drop the message from the POST
      formData.set('message', userText);
      const csrf = chatForm.querySelector('input[name="csrfmiddlewaretoken"]').value;
      try {
        const resp = await fetch(chatForm.action, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf },
          body: formData
        });
        const data = await resp.json();
        // Prefer explicit assistant_reply if provided
        const explicit = (data.assistant_reply || '').trim();
        if (explicit) {
          typeAssistantReply(msgList, explicit);
        } else if (Array.isArray(data.messages)) {
          const last = data.messages[data.messages.length - 1] || null;
          if (last && last.role === 'assistant') {
            typeAssistantReply(msgList, last.content || '');
          }
          msgList.scrollTop = msgList.scrollHeight;
        }
      } catch(err) {
        console.error('Chat submit failed', err);
      } finally {
        if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = btnOriginal; }
        if (sending) sending.remove();
        progressStop();
      }
    });
  }
});
</script>
{% endblock %}