{% extends 'docprocessor/base.html' %}
{% load static %}

{% block extra_css %}
<style>
  body { display:flex; min-height:100vh; flex-direction:column; }
  main { flex: 1 0 auto; }
  .site-footer { margin-top: auto; }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 24px auto 0;">
  <h2 style="margin-bottom: 16px;">Your Library</h2>
  <p style="color: #555; margin-top: -8px; margin-bottom: 24px;">Documents grouped by topic on the left. Get project recommendations on the right.</p>

  <div style="display: flex; gap: 24px; align-items: flex-start;">
    <!-- Left: Topics & Documents -->
    <section style="flex: 3; min-width: 0;">
      {% if topics %}
        {% for topic in topics %}
          <div class="card feature-card" style="margin-bottom: 16px;">
            <div style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 18px;">{{ topic.name }}</h3>
              <span style="font-size: 12px; color: #666;">{{ topic.documents|length }} docs</span>
            </div>
            <ul style="list-style: none; margin: 0; padding: 8px 16px;">
              {% for doc in topic.documents %}
                <li style="padding: 10px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between;">
                  <div>
                    <strong>{{ doc.title }}</strong>
                    <span style="color:#666; font-size: 12px;"> · {{ doc.get_document_type_display }} · {{ doc.uploaded_at|date:'M d, Y H:i' }}</span>
                  </div>
                  <div style="display: flex; gap: 8px;">
                    {% with last=doc.processedresult_set.last %}
                      {% if last %}
                        <a href="{% url 'document_result' last.id %}" style="font-size: 12px; color: #2563eb; text-decoration: none;">View last result</a>
                      {% else %}
                        <span style="font-size: 12px; color: #999;">No results yet</span>
                      {% endif %}
                    {% endwith %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}
      {% else %}
        <div class="card feature-card" style="padding: 16px;">
          <p>No documents yet. Upload from the <a href="{% url 'upload_document' %}">upload page</a>.</p>
        </div>
      {% endif %}
    </section>

    <!-- Right: Recommendations -->
    <aside style="flex: 2; min-width: 300px;">
      <div class="card feature-card">
        <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 18px;">Project Recommendations</h3>
          <button id="recommendBtn" style="background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer;">Recommend</button>
        </div>
        <div id="recommendationStatus" style="padding: 12px 16px; display:none; color:#555;"></div>
        <ul id="projectsList" style="list-style: none; margin: 0; padding: 12px 16px;"></ul>
        <div id="emptyState" style="padding: 16px; color:#666;">Click Recommend to generate project ideas based on your documents.</div>
      </div>
    </aside>
  </div>
</div>

<script>
(function() {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');
  const btn = document.getElementById('recommendBtn');
  const statusEl = document.getElementById('recommendationStatus');
  const listEl = document.getElementById('projectsList');
  const emptyEl = document.getElementById('emptyState');

  function renderProjects(projects) {
    listEl.innerHTML = '';
    if (!projects || !projects.length) {
      emptyEl.style.display = 'block';
      return;
    }
    emptyEl.style.display = 'none';
    projects.forEach(p => {
      const li = document.createElement('li');
      li.style.borderBottom = '1px dashed #eee';
      li.style.padding = '10px 0';
      const skills = Array.isArray(p.skills) ? p.skills : [];
      const relatedIds = Array.isArray(p.related_document_ids) ? p.related_document_ids : [];
      li.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:12px;">
          <div style="flex:1;">
            <strong>${p.title || 'Untitled'}</strong>
            <p style="margin:6px 0; color:#444;">${p.description || ''}</p>
            <div style="display:flex; flex-wrap:wrap; gap:6px;">
              ${skills.map(s => `<span style='background:#eef2ff; color:#374151; border:1px solid #dbeafe; border-radius:12px; padding:2px 8px; font-size:12px;'>${s}</span>`).join('')}
            </div>
          </div>
          <div style="min-width:120px; text-align:right; color:#666; font-size:12px;">Docs: ${relatedIds.join(', ')}</div>
        </div>
      `;
      listEl.appendChild(li);
    });
  }

  async function recommend() {
    statusEl.style.display = 'block';
    statusEl.textContent = 'Generating recommendations…';
    try {
      const resp = await fetch('{% url 'library_recommend' %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken || ''
        },
        body: JSON.stringify({})
      });
      if (!resp.ok) throw new Error('Request failed');
      const data = await resp.json();
      renderProjects(data.projects || []);
      statusEl.textContent = 'Done.';
      setTimeout(() => statusEl.style.display = 'none', 1000);
    } catch (e) {
      statusEl.textContent = 'Could not generate recommendations.';
    }
  }

  btn?.addEventListener('click', recommend);
})();
</script>
{% endblock %}